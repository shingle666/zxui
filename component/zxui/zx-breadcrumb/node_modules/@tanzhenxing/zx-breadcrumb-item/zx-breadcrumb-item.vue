<template>
	<view class="zx-breadcrumb-item" :class="[
		`zx-breadcrumb-item--${config.size}`,
		isLast && 'zx-breadcrumb-item--active',
		config.disabled && 'zx-breadcrumb-item--disabled'
	]">
		<!-- 面包屑内容 -->
		<view class="zx-breadcrumb-item__inner" @tap="handleClick" :style="[linkStyle]">
			<slot>
				<text class="zx-breadcrumb-item__text" :style="[textStyle]">{{ text }}</text>
			</slot>
		</view>

		<!-- 分隔符 -->
		<view class="zx-breadcrumb-item__separator" v-if="!isLast" :style="[separatorStyle]">
			<slot name="separator">
				<view v-if="config.separatorIcon" class="zx-breadcrumb-item__separator-icon">
					<image v-if="isImage(config.separatorIcon)" :src="config.separatorIcon" class="separator-image"></image>
					<zx-icon v-else :name="config.separatorIcon" :size="iconSize" :color="separatorColor"></zx-icon>
				</view>
				<text v-else class="zx-breadcrumb-item__separator-text">{{ config.separator }}</text>
			</slot>
		</view>
	</view>
</template>

<script setup>
/**
 * BreadcrumbItem 面包屑项
 * @description 面包屑的子组件
 * @property {String | Object}	to			路由跳转目标，同 vue-router 的 to 属性
 * @property {Boolean}			replace		如果设置该属性为 true, 导航将不会留下历史记录 （默认 false ）
 * @property {String | Number}	text		面包屑项的文字内容
 * @property {Boolean}			disabled	是否禁用该项 （默认 false ）
 * @property {String}			color		文字颜色
 * @property {String}			href		链接地址
 * @property {String}			target		链接打开方式 （默认 '_self' ）
 * @event {Function()} click 点击面包屑项时触发
 * @example <zx-breadcrumb-item to="/">首页</zx-breadcrumb-item>
 */
import { inject, computed, getCurrentInstance } from 'vue';

const { proxy } = getCurrentInstance();

const props = defineProps({
	// 路由跳转目标
	to: {
		type: [String, Object],
		default: ''
	},
	// 是否使用 replace 导航
	replace: {
		type: Boolean,
		default: false
	},
	// 面包屑项文字
	text: {
		type: [String, Number],
		default: ''
	},
	// 是否禁用
	disabled: {
		type: Boolean,
		default: false
	},
	// 文字颜色
	color: {
		type: String,
		default: ''
	},
	// 链接地址
	href: {
		type: String,
		default: ''
	},
	// 链接打开方式
	target: {
		type: String,
		default: '_self'
	}
});

const emit = defineEmits(['click']);

// 获取父组件提供的配置
const config = inject('breadcrumbConfig', {
	separator: '/',
	separatorIcon: '',
	size: 'default',
	disabled: false,
	color: '',
	activeColor: '',
	separatorColor: ''
});

// 检查是否为最后一项（当前页面）
const isLast = computed(() => {
	// 如果没有 to 属性且没有 href，认为是当前页面
	return !props.to && !props.href;
});

// 文字样式
const textStyle = computed(() => {
	const style = {};
	
	if (props.color) {
		style.color = props.color;
	} else if (config.color && !isLast.value) {
		style.color = config.color;
	} else if (config.activeColor && isLast.value) {
		style.color = config.activeColor;
	} else if (isLast.value) {
		style.color = '#909399'; // 默认当前页面颜色
	} else {
		style.color = '#606266'; // 默认链接颜色
	}
	
	return style;
});

// 链接样式
const linkStyle = computed(() => {
	const style = {};
	
	if (props.disabled || config.disabled || isLast.value) {
		style.cursor = 'default';
	} else {
		style.cursor = 'pointer';
	}
	
	return style;
});

// 分隔符样式
const separatorStyle = computed(() => {
	const style = {};
	
	if (config.separatorColor) {
		style.color = config.separatorColor;
	} else {
		style.color = '#c0c4cc'; // 默认分隔符颜色
	}
	
	return style;
});

// 分隔符颜色
const separatorColor = computed(() => {
	return config.separatorColor || '#c0c4cc';
});

// 图标大小
const iconSize = computed(() => {
	const sizeMap = {
		'small': 12,
		'default': 14,
		'large': 16
	};
	return sizeMap[config.size] || 14;
});

// 点击处理
const handleClick = () => {
	if (props.disabled || config.disabled || isLast.value) return;
	
	emit('click');
	
	// 处理路由跳转
	if (props.to) {
		if (proxy.$zx && proxy.$zx.route) {
			// 使用项目的路由方法
			if (props.replace) {
				proxy.$zx.route(props.to, 'replace');
			} else {
				proxy.$zx.route(props.to);
			}
		} else {
			// 备用路由处理
			console.log('路由跳转:', props.to);
		}
	} else if (props.href) {
		// 处理外部链接
		// #ifdef H5
		if (props.target === '_blank') {
			window.open(props.href);
		} else {
			window.location.href = props.href;
		}
		// #endif
		// #ifdef APP-PLUS
		plus.runtime.openURL(props.href);
		// #endif
	}
};

// 判断是否为图片
const isImage = (value) => {
	if (!value) return false;
	const newValue = value.split('?')[0];
	const IMAGE_REGEXP = /\.(jpeg|jpg|gif|png|svg|webp|jfif|bmp|dpg)/i;
	return IMAGE_REGEXP.test(newValue);
};
</script>

<style lang="scss" scoped>
.zx-breadcrumb-item {
	display: flex;
	align-items: center;

	&:last-child {
		.zx-breadcrumb-item__separator {
			display: none;
		}
	}

	&--disabled {
		opacity: 0.6;
		pointer-events: none;
	}

	&--active {
		.zx-breadcrumb-item__text {
			font-weight: 400;
		}
	}

	&__inner {
		transition: color 0.3s ease;

		&:hover {
			color: #409eff;
		}
	}

	&__text {
		transition: color 0.3s ease;
		white-space: nowrap;
	}

	&__separator {
		margin: 0 8px;
		display: flex;
		align-items: center;
		color: #c0c4cc;
		user-select: none;
	}

	&__separator-text {
		font-weight: normal;
	}

	&__separator-icon {
		display: flex;
		align-items: center;
		
		.separator-image {
			width: 14px;
			height: 14px;
		}
	}

	// 不同尺寸的间距调整
	&--small {
		.zx-breadcrumb-item__separator {
			margin: 0 6px;
		}
	}

	&--default {
		.zx-breadcrumb-item__separator {
			margin: 0 8px;
		}
	}

	&--large {
		.zx-breadcrumb-item__separator {
			margin: 0 10px;
		}
	}
}
</style> 